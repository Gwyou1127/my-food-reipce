<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>레시피 추가</title>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'BMJUA', sans-serif;
        background-color: #f4f7fa;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .container {
        position: relative;
        width: 800px;
        max-height: 2000px;
        background-color: white;
        border-radius: 10px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }


    .form-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 100%;
        max-width: 900px;
    }

    h2 {
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 1.75rem;
        color: #333;
    }

    label {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: #333;
        display: block;
    }

    input[type="text"], input[type="file"] {
        font-family: 'BMJUA', sans-serif;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    textarea {
        font-family: 'BMJUA', sans-serif;
        background-color: white;
        height: 120px;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        color: black;
    }

    input[type="text"]:focus, textarea:focus, input[type="file"]:focus {
        border-color: #ff6666;
        outline: none;
    }

    button {
        width: 100%;
        padding: 0.75rem;
        background-color: #ff6666;
        color: white;
        border: none;
        border-radius: 15px;
        font-size: 1.125rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #cc3333;
    }

    textarea {
        resize: vertical;
    }

    body.dark-mode {
        background-color: #1E1E1E;
        color: #E0E0E0;
    }

    body.dark-mode .container {
        background-color: #2C2C2C;
        box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }

    body.dark-mode .form-container {
        background-color: #2C2C2C;
        box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }

    body.dark-mode button {
        background-color: #FF6B6B;
        color: white;
    }

    body.dark-mode input {
        border: 2px solid #ddd;
        color: white;
        background-color: #333;
    }

    body.dark-mode textarea {
        border: 2px solid #ddd;
        color: white;
        background-color: #333;
    }
    
    body.dark-mode h2, label, p {
        color: #FF6B6B;
    }

    body.dark-mode button:hover {
        background-color: #cc3333;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .ingredients-group {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        width: 100%;
    }

    .ingredients-group .form-group {
        flex: 1;
        margin-bottom: 0;
        min-width: 0;
    }
    
    .ingredients-group label {
        display: block;
        margin-bottom: 8px;
        text-align: left;
    }

    input[type=file] {
        border: 2px dashed #ddd;
        padding: 1rem;
        text-align: center;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .file-upload p {
        margin-bottom: 1rem;
    }

    .recipe-upload {
        max-height: 600px;  /* Set a maximum height */
        overflow-y: auto;   /* Enable vertical scrolling */
        padding-right: 20px; /* Add some padding to prevent scrollbar overlap */
    }

    /* Optional: Style the scrollbar to make it more visually appealing */
    .recipe-upload::-webkit-scrollbar {
        width: 8px;
    }

    .recipe-upload::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .recipe-upload::-webkit-scrollbar-thumb {
        background: #ff6666;
        border-radius: 10px;
    }

    .recipe-upload::-webkit-scrollbar-thumb:hover {
        background: #cc3333;
    }


  </style>
  <style>
    @font-face {
    font-family: 'BMJUA';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/BMJUA.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    }
  </style>

</head>
<body>
    <div class="container">
        <form class="form-container">   
            <h2>자취요리 레시피 추가</h2>
            
            <div class="recipe-upload">
                <div class="form-group">
                    <label for="recipe-title">레시피 제목</label>
                    <input type="text" id="recipe-title" placeholder="레시피 제목을 입력하세요">
                </div>

                <div class="form-group">
                    <label for="recipe-explanation">요리 설명</label>
                    <textarea id="recipe-explanation" placeholder="요리 설명을 작성해주세요"></textarea>
                </div>
    
                <div class="ingredients-group">
                    <div class="form-group">
                        <label for="ingredients">재료</label>
                        <textarea id="ingredients" placeholder="재료를 입력하세요"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="sauce">양념장</label>
                        <textarea id="sauce" placeholder="양념장 재료를 입력하세요"></textarea>
                    </div>
                </div>
    
                <div class="form-group">
                    <label for="preparation">준비하기</label>
                    <textarea id="preparation" placeholder="준비 과정을 입력하세요"></textarea>
                </div>
    
                <div class="form-group">
                    <label for="cooking">조리하기</label>
                    <textarea id="cooking" placeholder="조리 과정을 입력하세요"></textarea>
                </div>
    
                <div class="file-upload">
                    <p>이미지 업로드</p>
                    <input type="file" id="recipe-image" accept="image/*">
                </div>
    
                <div class="button-group">
                    <button type="button" style="background-color: #666;" onclick="window.history.back()">뒤로가기</button>
                    <button type="button" id="send">수정하기</button>
                </div>
            </form>
        </div>
    </div>


<script>
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }



</script>

<script type="module" src="script.js"></script>




<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>  

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="crossorigin="anonymous"></script> 

<script>

const firebaseConfig = {
      apiKey: "your-api-key",
      authDomain: "your-api-key",
      projectId: "your-api-key",
      storageBucket: "your-api-key",
      messagingSenderId: "your-api-key",
      appId: "your-api-key"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage();
    const detailUrl = new URLSearchParams(window.location.search);

    let currentImageUrl = '';
    // 레시피 데이터를 불러와서 폼에 채우기
    db.collection('foods').doc(detailUrl.get('id')).get().then((result) => {
        const data = result.data();
        $('#recipe-title').val(data.name);
        $('#recipe-explanation').val(data.explanation);
        $('#ingredients').val(data.ingredients);
        $('#sauce').val(data.sauceIngredients);
        $('#preparation').val(data.preparation);
        $('#cooking').val(data.cooking);

        if (data.image) {
            const imgPreview = document.createElement('img');
            imgPreview.src = data.image;
            imgPreview.alt = "Recipe Image Preview";
            imgPreview.style.width = "30%";
            imgPreview.style.height = "30%";
            imgPreview.style.borderRadius = "8px";
            document.querySelector('.file-upload').appendChild(imgPreview);
        }

        if (data && data.image) {
            currentImageUrl = data.image;
            console.log('Fetched imageUrl:', currentImageUrl);
        } else {
            console.warn('No imageUrl found.');
        }
    }).then(async () => {

    });


    const uploadnewImage = async (file) => {
        const storageRef = storage.ref(`image/${file.name}`);
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        return downloadURL;
    };

    const deleteOldImage = async (imageUrl) => {
        try {
            const storageRef = storage.refFromURL(imageUrl);
            await storageRef.delete();
            console.log('기존 이미지가 성공적으로 삭제되었습니다.');
        } catch (error) {
            console.error('기존 이미지 삭제 중 오류 발생:', error);
        }
    };
    

    // 수정하기 버튼 클릭 이벤트
    $('#send').click(async function () {
        const recipeId = detailUrl.get('id');
        const fileInput = document.getElementById('recipe-image');
        let imageUrl;

        // 이미지가 업로드되었을 경우 처리
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            imageUrl = await uploadnewImage(file);

            // 이미지 삭제 및 업로드 로직
            if (currentImageUrl) {
                await deleteOldImage(currentImageUrl); // 기존 이미지 삭제
                console.log('Deleted old image:', currentImageUrl);
            }
            const newImageUrl = await uploadnewImage(imageUrl); // 새 이미지 업로드
            console.log('Uploaded new image:', newImageUrl);
            }

        const change = {
            name: $('#recipe-title').val(),
            explanation: $('#recipe-explanation').val(),
            ingredients: $('#ingredients').val(),
            sauceIngredients: $('#sauce').val(),
            preparation: $('#preparation').val(),
            cooking: $('#cooking').val(),
            image: imageUrl // 이미지 URL이 있을 경우에만 추가
        };

        db.collection('foods').doc(recipeId).update(change).then(() => {
            alert('성공적으로 레시피가 수정되었습니다.');
            window.location.href = './mypage.html';
        }).catch((error) => {
            console.error("Error updating document: ", error);
            alert('수정 중 오류가 발생했습니다.');
        });
    });



</script>
</body>
</html>
